{% extends "base.html" %}

{% block title %}Payroll Records{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <div>
            <h2 style="color: #667eea; margin-bottom: 10px;">üí∞ Payroll Records</h2>
            <p style="color: #666;">View all processed payrolls</p>
        </div>
        
        <div style="display: flex; gap: 10px;">
            <!-- Month Selector -->
            <form method="GET" style="display: flex; gap: 10px;">
                <input type="month" 
                       name="month" 
                       value="{{ month }}" 
                       class="form-control"
                       style="padding: 10px;"
                       onchange="this.form.submit()">
                <button type="submit" class="btn btn-primary">Filter</button>
            </form>
            
            <!-- Process Payroll Button -->
            <a href="{{ url_for('admin_process_payroll') }}" class="btn btn-success">
                ‚ûï Process Payroll
            </a>
        </div>
    </div>

    {% if records %}
    <!-- Summary Cards -->
    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px;">
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; text-align: center;">
            <h3 style="font-size: 32px; margin-bottom: 5px;">{{ records|length }}</h3>
            <p style="opacity: 0.9;">Total Employees</p>
        </div>
        
        <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; padding: 20px; border-radius: 10px; text-align: center;">
            <h3 style="font-size: 24px; margin-bottom: 5px;">
                ‚Çπ{{ "%.2f"|format(records|sum(attribute='gross_salary')) }}
            </h3>
            <p style="opacity: 0.9;">Total Gross</p>
        </div>
        
        <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 10px; text-align: center;">
            <h3 style="font-size: 24px; margin-bottom: 5px;">
                ‚Çπ{{ "%.2f"|format(records|sum(attribute='epf_deduction') + records|sum(attribute='tds_deduction') + records|sum(attribute='lop_deduction')) }}
            </h3>
            <p style="opacity: 0.9;">Total Deductions</p>
        </div>
        
        <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 20px; border-radius: 10px; text-align: center;">
            <h3 style="font-size: 24px; margin-bottom: 5px;">
                ‚Çπ{{ "%.2f"|format(records|sum(attribute='net_salary')) }}
            </h3>
            <p style="opacity: 0.9;">Total Net Payable</p>
        </div>
    </div>

    <!-- Payroll Table -->
    <div style="overflow-x: auto;">
        <table class="table" id="payrollTable">
            <thead>
                <tr>
                    <th>Trans ID</th>
                    <th>Employee</th>
                    <th>Department</th>
                    <th>Days Present</th>
                    <th>Base Salary</th>
                    <th>Gross Salary</th>
                    <th>Deductions</th>
                    <th>Net Salary</th>
                    <th>Status</th>
                    
                </tr>
            </thead>
            <tbody>
                {% for record in records %}
                <tr data-trans-id="{{ record.trans_id }}"
                    data-name="{{ record.name }}"
                    data-emp-id="{{ record.emp_id }}"
                    data-department="{{ record.department or 'N/A' }}"
                    data-days-present="{{ record.days_present }}"
                    data-total-days="{{ record.total_days }}"
                    data-base-salary="{{ '%.2f'|format(record.base_salary) }}"
                    data-gross-salary="{{ '%.2f'|format(record.gross_salary) }}"
                    data-deductions="{{ '%.2f'|format(record.epf_deduction + record.tds_deduction + record.lop_deduction) }}"
                    data-net-salary="{{ '%.2f'|format(record.net_salary) }}"
                    data-status="{{ record.status }}">
                    
                    <td><strong>#{{ record.trans_id }}</strong></td>
                    
                    <td>
                        <strong>{{ record.name }}</strong><br>
                        <small style="color: #666;">{{ record.emp_id }}</small>
                    </td>
                    
                    <td>{{ record.department or 'N/A' }}</td>
                    
                    <td>
                        <strong>{{ record.days_present }}</strong> / {{ record.total_days }}<br>
                        <small style="color: #28a745;">
                            {{ "%.1f"|format((record.days_present / record.total_days * 100) if record.total_days > 0 else 0) }}%
                        </small>
                    </td>
                    
                    <td>‚Çπ{{ "%.2f"|format(record.base_salary) }}</td>
                    
                    <td>
                        <strong style="color: #28a745; font-size: 15px;">
                            ‚Çπ{{ "%.2f"|format(record.gross_salary) }}
                        </strong>
                    </td>
                    
                    <td style="color: #dc3545;">
                        -‚Çπ{{ "%.2f"|format(record.epf_deduction + record.tds_deduction + record.lop_deduction) }}
                        <br>
                        <small style="font-size: 11px; display: block; margin-top: 3px;">
                            EPF: ‚Çπ{{ "%.2f"|format(record.epf_deduction) }}<br>
                            TDS: ‚Çπ{{ "%.2f"|format(record.tds_deduction) }}
                        </small>
                    </td>
                    
                    <td>
                        <strong style="color: #667eea; font-size: 16px;">
                            ‚Çπ{{ "%.2f"|format(record.net_salary) }}
                        </strong>
                    </td>
                    
                    <td>
                        {% if record.status == 'Processed' %}
                            <span style="background: #d4edda; color: #155724; padding: 5px 10px; border-radius: 5px; font-size: 12px;">
                                ‚úì Processed
                            </span>
                        {% elif record.status == 'Paid' %}
                            <span style="background: #d1ecf1; color: #0c5460; padding: 5px 10px; border-radius: 5px; font-size: 12px;">
                                üí∞ Paid
                            </span>
                        {% else %}
                            <span style="background: #fff3cd; color: #856404; padding: 5px 10px; border-radius: 5px; font-size: 12px;">
                                ‚è≥ Pending
                            </span>
                        {% endif %}
                    </td>
                    
                    <td>
                        <div style="display: flex; gap: 5px;">
                            {% if record.pdf_path %}
                            <a href="{{ url_for('download_payslip', trans_id=record.trans_id) }}" 
                               class="btn btn-primary"
                               style="padding: 5px 10px; font-size: 12px;"
                               title="Download PDF">
                                üì• PDF
                            </a>
                            {% endif %}
                         </a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Export Options -->
    <div style="margin-top: 30px; text-align: center; padding: 20px; background: #f8f9fa; border-radius: 10px;">
        <h4 style="margin-bottom: 15px; color: #667eea;">üìä Export Options</h4>
        <div style="display: flex; gap: 15px; justify-content: center;">
            <button onclick="exportToExcel()" class="btn btn-success">
                üìó Export to Excel
            </button>
            <button onclick="window.print()" class="btn btn-primary">
                üñ®Ô∏è Print Report
            </button>
        </div>
    </div>

    {% else %}
    <!-- No Records Message -->
    <div style="text-align: center; padding: 80px 20px; color: #999;">
        <div style="font-size: 64px; margin-bottom: 20px;">üì≠</div>
        <h3 style="color: #666; margin-bottom: 10px;">No Payroll Records Found</h3>
        <p style="margin-bottom: 30px;">
            No payroll has been processed for <strong>{{ month }}</strong> yet.
        </p>
        
        <div style="background: #fff3cd; padding: 20px; border-radius: 10px; max-width: 600px; margin: 0 auto 20px; text-align: left;">
            <h4 style="color: #856404; margin-bottom: 10px;">üí° To process payroll:</h4>
            <ol style="margin: 10px 0 0 20px; line-height: 1.8; color: #856404;">
                <li>Ensure all employees have attendance marked for {{ month }}</li>
                <li>Click the "Process Payroll" button above</li>
                <li>Select the month and confirm processing</li>
                <li>Payroll will be calculated automatically for all active employees</li>
            </ol>
        </div>
        
        <a href="{{ url_for('admin_process_payroll') }}" class="btn btn-success" style="padding: 15px 30px; font-size: 16px;">
            ‚ûï Process Payroll for {{ month }}
        </a>
    </div>
    {% endif %}
</div>

<style>
.table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.table thead {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.table thead th {
    padding: 15px 10px;
    text-align: left;
    font-weight: 600;
    font-size: 13px;
}

.table tbody tr {
    border-bottom: 1px solid #eee;
    transition: background 0.3s;
}

.table tbody tr:hover {
    background: #f8f9ff;
}

.table tbody td {
    padding: 15px 10px;
    font-size: 13px;
}

.card {
    background: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 2px 20px rgba(0,0,0,0.1);
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight: 600;
    text-decoration: none;
    display: inline-block;
    transition: all 0.3s;
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.btn-success {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    color: white;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

.form-control {
    padding: 10px;
    border: 2px solid #e0e0e0;
    border-radius: 5px;
    font-size: 14px;
}

@media print {
    .btn, .form-control, form {
        display: none !important;
    }
}
</style>

<script>
function exportToExcel() {
    // FIXED: Read data from HTML data attributes instead of Jinja loop
    let csv = 'Trans ID,Employee,Emp ID,Department,Days Present,Total Days,Base Salary,Gross Salary,Deductions,Net Salary,Status\n';
    
    // Get all table rows with data
    const rows = document.querySelectorAll('#payrollTable tbody tr');
    
    rows.forEach(function(row) {
        const transId = row.getAttribute('data-trans-id');
        const name = row.getAttribute('data-name');
        const empId = row.getAttribute('data-emp-id');
        const department = row.getAttribute('data-department');
        const daysPresent = row.getAttribute('data-days-present');
        const totalDays = row.getAttribute('data-total-days');
        const baseSalary = row.getAttribute('data-base-salary');
        const grossSalary = row.getAttribute('data-gross-salary');
        const deductions = row.getAttribute('data-deductions');
        const netSalary = row.getAttribute('data-net-salary');
        const status = row.getAttribute('data-status');
        
        csv += transId + ',';
        csv += '"' + name + '",';
        csv += empId + ',';
        csv += '"' + department + '",';
        csv += daysPresent + ',';
        csv += totalDays + ',';
        csv += baseSalary + ',';
        csv += grossSalary + ',';
        csv += deductions + ',';
        csv += netSalary + ',';
        csv += status + '\n';
    });
    
    // Create and download CSV file
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = window.URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = 'payroll_{{ month }}.csv';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    window.URL.revokeObjectURL(url);
    
    alert('‚úÖ Payroll data exported successfully!');
}
</script>
{% endblock %}